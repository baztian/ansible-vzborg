########################################################################
# File managed by Ansible
# Your changes will be overwritten.
########################################################################
{# Copied from borgrmatic.service and modified for vzborg #}
[Unit]
Description=vzborg backup
Wants=network-online.target
After=network-online.target
# Prevent vzborg from running unless the machine is plugged into power. Remove this line if you
# want to allow vzborg to run anytime.
ConditionACPower=true
ConditionFileNotEmpty=/etc/vzborg/default

[Service]
Type=oneshot

# Security settings for systemd running as root, optional but recommended to improve security. You
# can disable individual settings if they cause problems for your use case. For more details, see
# the systemd manual: https://www.freedesktop.org/software/systemd/man/systemd.exec.html

# Lower CPU and I/O priority.
Nice=19
CPUSchedulingPolicy=batch
IOSchedulingClass=best-effort
IOSchedulingPriority=7
IOWeight=100

Restart=no
# Prevent rate limiting of vzborg log events. If you are using an older version of systemd that
# doesn't support this (pre-240 or so), you may have to remove this option.
LogRateLimitIntervalSec=0

# Delay start to prevent backups running during boot. Note that systemd-inhibit requires dbus and
# dbus-user-session to be installed.
ExecStartPre=sleep 1m
ExecStart=systemd-inhibit --who="vzborg" --what="sleep:shutdown" --why="Prevent interrupting scheduled backup" /usr/local/bin/vzborg-tagged-vms.sh
